<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>JB VIN Decoder</title>
  <meta name="color-scheme" content="dark">
  <meta name="theme-color" content="#0e1214">

  <!-- Perf: preconnect -->
  <link rel="preconnect" href="https://vpic.nhtsa.dot.gov">

  <style>
    :root{
      --bg:#0e1214;
      --card:#151b1f;
      --row:#10161a;

      --text:#e6edf3;
      --muted:#9aa7b2;

      --accent:#3b82f6;
      --accent2:#2563eb;

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --border:rgba(255,255,255,.08);
      --shadow: 0 18px 50px rgba(0,0,0,.35);

      --radius:18px;
      --radius2:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 520px at 20% -10%, rgba(59,130,246,.20), transparent 60%),
        radial-gradient(900px 520px at 90% 10%, rgba(37,99,235,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding-bottom: calc(18px + env(safe-area-inset-bottom));
    }

    .app{
      max-width:620px;
      margin:0 auto;
      padding:16px;
    }

    /* ================= HEADER ================= */
    .header{
      text-align:center;
      padding:14px 0 10px;
    }

    .logo{
      width:56px;height:56px;
      margin:0 auto 10px;
      border-radius:14px;
      background:#0f172a;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:var(--accent);
      border:1px solid var(--border);
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
      overflow:hidden;
    }

    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:14px;
      display:block;
    }

    h1{
      margin:4px 0 4px;
      font-size:19px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* ================= CARD ================= */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)),
                 var(--card);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
    }

    /* ================= INPUT / BUTTONS ================= */
    .stack{display:grid; gap:10px}

    input{
      width:100%;
      padding:13px 13px;
      border-radius:var(--radius2);
      border:1px solid var(--border);
      background:#0b1116;
      color:var(--text);
      text-transform:uppercase;
      font-size:14px;
      letter-spacing:.6px;
    }

    input:focus{
      outline:none;
      border-color:rgba(59,130,246,.8);
      box-shadow: 0 0 0 4px rgba(59,130,246,.18);
    }

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }

    button{
      width:100%;
      padding:12px;
      border-radius:var(--radius2);
      border:1px solid var(--border);
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#0b1116;
      color:var(--text);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    button:active{transform:scale(.99)}
    button[disabled]{opacity:.6; cursor:not-allowed}

    .primary{
      background:linear-gradient(180deg,var(--accent),var(--accent2));
      color:#fff;
      border:none;
    }

    .secondary{
      background:#0b1116;
      color:var(--text);
    }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
      justify-content:space-between;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      background:#0b1116;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .toggle input{width:auto; margin:0}
    .miniBtns{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .miniBtn{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
    }

    /* ================= STATUS ================= */
    .status{
      margin-top:10px;
      font-size:12px;
      min-height:18px;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      line-height:1.35;
    }

    .dot{
      width:8px;height:8px;border-radius:99px;
      background:rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .status.ok{color:var(--ok)}
    .status.ok .dot{background:var(--ok); box-shadow:0 0 0 3px rgba(34,197,94,.18)}
    .status.bad{color:var(--bad)}
    .status.bad .dot{background:var(--bad); box-shadow:0 0 0 3px rgba(239,68,68,.18)}
    .status.warn{color:var(--warn)}
    .status.warn .dot{background:var(--warn); box-shadow:0 0 0 3px rgba(245,158,11,.18)}

    .hint{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }

    /* ================= VEHICLE SUMMARY ================= */
    .vehicle{
      margin-top:14px;
      padding:14px;
      border-radius:16px;
      background:
        radial-gradient(650px 240px at 30% 0%, rgba(59,130,246,.20), transparent 55%),
        #0f172a;
      text-align:center;
      font-weight:950;
      font-size:16px;
      display:none;
      border:1px solid var(--border);
    }

    .vehicle small{
      display:block;
      margin-top:6px;
      font-size:12px;
      font-weight:800;
      color:#aeb8c2;
    }

    /* ================= TABS ================= */
    .tabs{
      margin-top:12px;
      display:flex;
      gap:8px;
      overflow:auto;
      padding-bottom:2px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}

    .tab{
      flex:0 0 auto;
      padding:9px 12px;
      border-radius:999px;
      background:#0b1116;
      color:var(--muted);
      border:1px solid var(--border);
      font-size:12px;
      font-weight:950;
      white-space:nowrap;
    }

    .tab.active{
      background:#0f172a;
      color:var(--text);
      border-color:rgba(59,130,246,.7);
    }

    /* ================= RESULTS ================= */
    .results,.oem{
      margin-top:14px;
      display:grid;
      gap:8px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      background:var(--row);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
    }

    .k{
      font-size:11px;
      color:var(--muted);
      line-height:1.25;
      max-width:55%;
    }

    .v{
      font-size:13px;
      font-weight:950;
      text-align:right;
      line-height:1.2;
      overflow-wrap:anywhere;
      max-width:45%;
    }

    .row.copyable{cursor:pointer}
    .row.copyable:active{filter:brightness(1.08)}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:calc(14px + env(safe-area-inset-bottom));
      background:rgba(15,23,42,.92);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      color:var(--text);
      display:none;
      box-shadow: var(--shadow);
      z-index:9999;
    }

    /* ================= OEM ================= */
    .oem h3{
      font-size:13px;
      margin:10px 0 6px;
      color:var(--accent);
      letter-spacing:.2px;
    }

    /* ================= WORKFLOW ================= */
    #workflow{
      margin-top:14px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#0b1116;
      display:none;
    }
    #workflow h3{margin:0 0 10px; color:var(--accent2); font-size:13px}
    .bucket{display:grid; gap:8px; margin-top:10px}
    .bucketTitle{
      display:flex; align-items:center; gap:8px;
      font-size:12px; font-weight:950;
      color:var(--text);
    }
    .pill{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .listRow{
      background:var(--row);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .listRow .k{max-width:65%}
    .listRow .v{max-width:35%}

    /* ================= HISTORY ================= */
    .history{
      margin-top:12px;
      display:none;
      border-top:1px dashed rgba(255,255,255,.10);
      padding-top:12px;
    }
    .historyHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .historyHead b{font-size:12px;font-weight:950}
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--border);
      background:#0b1116;
      color:var(--text);
      font-weight:950;
      font-size:11px;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip span{color:var(--muted); font-weight:900}
    .chip:active{transform:scale(.99)}

    /* ================= FOOTER ================= */
    .disclaimer{
      margin-top:14px;
      font-size:10px;
      color:#7c8793;
      line-height:1.4;
    }
    .footer{
      text-align:center;
      margin-top:18px;
      font-size:10px;
      color:#7c8793;
    }

    /* ================= PRINT (LOGO + RESULTS ONLY) ================= */
    @media print{
      body{background:#fff !important; color:#000 !important}
      .header, .btns, .tabs, .status, .hint, .disclaimer, .footer, #workflow, .toolbar, .history{display:none !important}
      .card{box-shadow:none !important; border:0 !important; background:#fff !important}
      .app{max-width:900px}
      .printHeader{
        display:flex !important;
        align-items:center;
        gap:12px;
        margin-bottom:14px;
      }
      .printHeader .pLogo{
        width:54px;height:54px;border-radius:10px;border:1px solid #ddd;overflow:hidden;
        display:flex;align-items:center;justify-content:center;
      }
      .printHeader .pLogo img{width:100%;height:100%;object-fit:cover}
      .printHeader .pTitle{font-size:16px;font-weight:950}
      .printHeader .pSub{font-size:11px;color:#333}
      .vehicle{display:block !important; background:#fff !important; border:1px solid #ddd !important}
      .row{background:#fff !important; border:1px solid #ddd !important}
      .k{color:#333 !important}
      .v{color:#000 !important}
      .tab-panel{display:grid !important}
    }
    .printHeader{display:none}

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important}
    }
  </style>
</head>

<body>
  <div class="toast" id="toast">Copied</div>

  <div class="app">
    <div class="header">
      <div class="logo" aria-label="JB logo">
        <img src="logo.png" alt="JB"
             onerror="this.remove(); this.parentNode.textContent='JB';">
      </div>
      <h1>JB VIN Decoder</h1>
      <div class="sub">VIN-accurate specs • Fewer wrong parts • Faster counter work</div>
    </div>

    <div class="card">
      <!-- print header (only shows in print) -->
      <div class="printHeader">
        <div class="pLogo"><img src="logo.png" alt="JB"></div>
        <div>
          <div class="pTitle">JB VIN Decoder</div>
          <div class="pSub">Vehicle summary + decoded specs</div>
        </div>
      </div>

      <div class="stack">
        <input id="vin" maxlength="17" placeholder="ENTER 17-CHARACTER VIN"
               inputmode="text" autocomplete="off" aria-label="VIN input" />

        <div class="btns">
          <button class="primary" id="decodeBtn" onclick="decode()">Decode</button>
          <button class="secondary" onclick="resetAll()">Reset</button>
          <button class="secondary" onclick="printReport()">Print</button>
        </div>

        <div class="toolbar">
          <label class="toggle" title="Auto-decode when VIN reaches 17 chars">
            <input id="autoDecode" type="checkbox">
            Auto-decode
          </label>

          <div class="miniBtns">
            <button class="miniBtn secondary" type="button" onclick="fillSample()">Sample VINs</button>
            <button class="miniBtn secondary" type="button" onclick="toggleAdvanced()">Advanced</button>
          </div>
        </div>
      </div>

      <div id="status" class="status"><span class="dot"></span><span id="statusText"></span></div>
      <div class="hint" id="hint">
        Tip: paste a VIN, it auto-cleans. Tap any row to copy. Print is logo + vehicle + decoded rows.
      </div>

      <div id="vehicle" class="vehicle"></div>

      <div class="tabs" role="tablist" aria-label="VIN Decoder Tabs">
        <button class="tab active" data-tab="core" role="tab" aria-selected="true">Core</button>
        <button class="tab" data-tab="engine" role="tab" aria-selected="false">Engine</button>
        <button class="tab" data-tab="drive" role="tab" aria-selected="false">Drive</button>
        <button class="tab" data-tab="body" role="tab" aria-selected="false">Body</button>
        <button class="tab" data-tab="safety" role="tab" aria-selected="false">Safety</button>
        <button class="tab" id="advTabBtn" data-tab="advanced" role="tab" aria-selected="false" style="display:none">Advanced</button>
      </div>

      <div id="core" class="results tab-panel"></div>
      <div id="engine" class="results tab-panel" style="display:none"></div>
      <div id="drive" class="results tab-panel" style="display:none"></div>
      <div id="body" class="results tab-panel" style="display:none"></div>
      <div id="safety" class="results tab-panel" style="display:none"></div>
      <div id="advanced" class="results tab-panel" style="display:none"></div>

      <div id="oem" class="oem" style="display:none"></div>

      <!-- Parts Counter Guide -->
      <div id="workflow">
        <h3>Parts Counter Guide</h3>
        <div class="bucket">
          <div class="bucketTitle">✅ Safe to order <span class="pill">VIN-decided</span></div>
          <div id="safe"></div>
        </div>
        <div class="bucket">
          <div class="bucketTitle">⚠ Verify first <span class="pill">needs confirmation</span></div>
          <div id="verify"></div>
        </div>
        <div class="bucket">
          <div class="bucketTitle">⛔ High risk <span class="pill">too many variants</span></div>
          <div id="unsafe"></div>
        </div>
      </div>

      <!-- History -->
      <div class="history" id="history">
        <div class="historyHead">
          <b>Recent VINs</b>
          <button class="miniBtn secondary" type="button" onclick="clearHistory()">Clear</button>
        </div>
        <div class="chips" id="chips"></div>
      </div>

      <div class="disclaimer">
        OEM compatibility is VIN-matched by configuration. Exact part numbers require manufacturer or licensed catalogs.
      </div>
    </div>

    <div class="footer">JB VIN Decoder • Built for speed + accuracy</div>
  </div>

  <script>
    /* =======================
       DOM
    ======================= */
    const vinEl = document.getElementById("vin");
    const vehicleEl = document.getElementById("vehicle");
    const statusWrap = document.getElementById("status");
    const statusText = document.getElementById("statusText");
    const decodeBtn = document.getElementById("decodeBtn");
    const toast = document.getElementById("toast");

    const panels = ["core","engine","drive","body","safety","advanced"];
    let activePanel = "core";
    let busy = false;

    // cache last decode so print works
    let last = { vin:"", d:null, ts:0, source:"" };

    // history
    const HISTORY_KEY = "jb_vin_history_v2";
    let history = loadHistory();

    // advanced fields toggle
    let advancedOn = false;

    /* =======================
       BASIC HELPERS
    ======================= */
    function clean(v){ return (v||"").toUpperCase().replace(/[^A-Z0-9]/g,""); }
    function valid(v){ return v.length === 17 && !/[IOQ]/.test(v); }
    function lower(x){ return (x||"").toString().toLowerCase(); }
    function has(v){ return !!(v && v !== "Not Applicable"); }

    function setStatus(msg, type=""){
      statusText.textContent = msg || "";
      statusWrap.className = "status" + (type ? " " + type : "");
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display="none", 950);
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[m]));
    }

    /* =======================
       CONFIG DETECTORS
    ======================= */
    function isCVT(d){ return lower(d.TransmissionStyle).includes("cvt"); }
    function isAutomatic(d){ return lower(d.TransmissionStyle).includes("auto"); }
    function isManual(d){ return lower(d.TransmissionStyle).includes("manual"); }
    function isDiesel(d){ return lower(d.FuelTypePrimary).includes("diesel"); }
    function isElectric(d){
      return lower(d.ElectrificationLevel).includes("electric") ||
             lower(d.FuelTypePrimary).includes("electric");
    }
    function isAWD(d){
      const t = lower(d.DriveType);
      return t.includes("awd") || t.includes("all wheel");
    }

    /* =======================
       SCORING / LOGIC
    ======================= */
    function confidenceScore(d){
      let s = 0;
      if(has(d.Make)) s+=10;
      if(has(d.Model)) s+=10;
      if(has(d.ModelYear)) s+=10;
      if(has(d.EngineModel) || has(d.DisplacementL) || has(d.EngineCylinders)) s+=20;
      if(has(d.TransmissionStyle) || has(d.TransmissionSpeeds)) s+=20;
      if(has(d.DriveType)) s+=15;
      if(has(d.BodyClass) || has(d.Doors)) s+=15;
      return Math.min(100, s);
    }

    function orderReadiness(d){
      if((has(d.EngineModel) || has(d.DisplacementL)) && has(d.TransmissionStyle) && has(d.DriveType))
        return "✓ Ready for most mechanical parts";
      if((has(d.Make) && has(d.Model) && has(d.ModelYear)))
        return "⚠ Good base — verify engine/trans before ordering";
      return "⛔ Decode incomplete — verify configuration";
    }

    function platformGroup(d){
      const mk = (d.Make||"").toUpperCase();
      const md = (d.Model||"").toUpperCase();
      if(mk==="TOYOTA" && md==="COROLLA") return "Toyota Corolla platform family";
      if(mk==="HONDA" && md==="CIVIC") return "Honda Global Small platform";
      return "Platform data unavailable";
    }

    function sanityCheck(d){
      if(!has(d.Make) || !has(d.Model) || !has(d.ModelYear)) return "⚠ Missing key identifiers";
      return "✓ VIN configuration consistent";
    }

    /* =======================
       UI HELPERS
    ======================= */
    function getPanel(id){ return document.getElementById(id); }

    function clearPanels(){
      document.querySelectorAll(".tab-panel").forEach(p => p.innerHTML = "");
    }

    function addRow(panelId, k, v){
      if(!has(v)) return;
      const panel = getPanel(panelId);
      if(!panel) return;

      const safeK = escapeHtml(k);
      const safeV = escapeHtml(String(v));

      panel.insertAdjacentHTML("beforeend", `
        <div class="row copyable" data-copy="${safeV}">
          <div class="k">${safeK}</div>
          <div class="v">${safeV}</div>
        </div>
      `);
    }

    function buildVehicleSummary(d, v){
      const line1 = `${d.ModelYear || ""} ${d.Make || ""} ${d.Model || ""}`.trim() || "Vehicle";
      const e = d.EngineModel || (d.DisplacementL ? `${d.DisplacementL} L` : "Unknown engine");
      const t = d.TransmissionStyle || "Unknown trans";
      const dr = d.DriveType || "Unknown drive";
      vehicleEl.innerHTML = `${escapeHtml(line1)}<small>${escapeHtml(e)} • ${escapeHtml(t)} • ${escapeHtml(dr)}</small>`;
      vehicleEl.style.display = "block";
    }

    function oemSection(title, list){
      if(!list.length) return "";
      const safeTitle = escapeHtml(title);
      return `<h3>${safeTitle}</h3>` + list.map(i=>{
        const s = escapeHtml(i);
        return `
          <div class="row copyable" data-copy="${s}">
            <div class="k">•</div>
            <div class="v">${s}</div>
          </div>
        `;
      }).join("");
    }

    function showWorkflow(d){
      const wf = document.getElementById("workflow");
      const safeEl = document.getElementById("safe");
      const verifyEl = document.getElementById("verify");
      const unsafeEl = document.getElementById("unsafe");

      safeEl.innerHTML = "";
      verifyEl.innerHTML = "";
      unsafeEl.innerHTML = "";

      const safe = [];
      const verify = [];
      const unsafe = [];

      safe.push("Cabin air filter", "Wiper blades");

      if(isElectric(d)){
        verify.push("High-voltage components (catalog required)");
        unsafe.push("Inverter/drive unit (option-heavy)");
      }else{
        if(has(d.EngineModel) || has(d.DisplacementL)) safe.push("Oil filter (engine-known)");
        else verify.push("Oil filter (confirm engine)");
        if(isManual(d)) verify.push("Clutch kit (confirm trans code)");
        if(isCVT(d)) unsafe.push("CVT valve body / TCM (variant-heavy)");
      }

      if(isAWD(d)) verify.push("Transfer case service parts");
      if(isDiesel(d)) verify.push("Fuel filter (diesel-specific)");

      const renderList = (el, items) => {
        if(!items.length){
          el.innerHTML = `<div class="row"><div class="k">—</div><div class="v">None</div></div>`;
          return;
        }
        el.innerHTML = items.map(i => `
          <div class="listRow copyable" data-copy="${escapeHtml(i)}">
            <div class="k">${escapeHtml(i)}</div>
            <div class="v">Copy</div>
          </div>
        `).join("");
      };

      renderList(safeEl, safe);
      renderList(verifyEl, verify);
      renderList(unsafeEl, unsafe);

      wf.style.display = "block";
    }

    /* =======================
       TABS (better than onclick strings)
    ======================= */
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-tab");
        showTab(id);
      });
    });

    function showTab(id){
      activePanel = id;
      document.querySelectorAll(".tab-panel").forEach(p => p.style.display = "none");
      const panel = getPanel(id);
      if(panel) panel.style.display = "grid";

      document.querySelectorAll(".tab").forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-selected","false");
      });

      const btn = document.querySelector(`.tab[data-tab="${id}"]`);
      if(btn){
        btn.classList.add("active");
        btn.setAttribute("aria-selected","true");
      }
    }

    /* =======================
       FETCH (direct + proxy fallback) with source
    ======================= */
    async function fetchDecode(v){
      const url = `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${v}?format=json`;

      // 1) direct
      try{
        const r1 = await fetch(url, { cache:"no-store" });
        if(!r1.ok) throw new Error("Direct response not OK");
        return { json: await r1.json(), source:"direct" };
      }catch(_){
        // 2) proxy
        const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
        const r2 = await fetch(proxy, { cache:"no-store" });
        if(!r2.ok) throw new Error("Proxy response not OK");
        return { json: await r2.json(), source:"proxy" };
      }
    }

    /* =======================
       MAIN DECODE
    ======================= */
    async function decode(){
      let v = clean(vinEl.value);
      vinEl.value = v;

      if(!valid(v)){
        setStatus("Invalid VIN (17 chars, no I/O/Q).", "bad");
        vehicleEl.style.display = "none";
        return;
      }

      const now = Date.now();
      if(last.vin === v && last.d && (now - last.ts) < 60_000){
        renderAll(last.d, v);
        setStatus(`Loaded from cache (last 60s). Source: ${last.source}.`, "ok");
        return;
      }

      if(busy) return;
      busy = true;
      decodeBtn.disabled = true;

      setStatus("Decoding VIN…", "warn");
      clearPanels();
      document.getElementById("oem").innerHTML = "";
      document.getElementById("oem").style.display = "none";
      document.getElementById("workflow").style.display = "none";
      vehicleEl.style.display = "none";

      try{
        const { json, source } = await fetchDecode(v);
        const d = json?.Results?.[0] || {};

        last = { vin:v, d, ts:Date.now(), source };

        // history
        pushHistory(v, d);
        renderHistory();

        renderAll(d, v);
        setStatus(`VIN decoded successfully. Source: ${source}.`, "ok");
      }catch(err){
        setStatus("Decode failed. Check connection (or CORS). Try again.", "bad");
      }

      busy = false;
      decodeBtn.disabled = false;
    }

    function renderAll(d, v){
      clearPanels();
      buildVehicleSummary(d, v);

      // CORE
      addRow("core", "VIN", v);
      addRow("core", "Model Year", d.ModelYear);
      addRow("core", "Make", d.Make);
      addRow("core", "Model", d.Model);
      addRow("core", "Trim", d.Trim);
      addRow("core", "Series", d.Series);
      addRow("core", "Vehicle Type", d.VehicleType);
      addRow("core", "Body Class", d.BodyClass);
      addRow("core", "Plant Country", d.PlantCountry);
      addRow("core", "Plant City", d.PlantCity);
      addRow("core", "Manufacturer", d.Manufacturer);
      addRow("core", "Decode Confidence", `${confidenceScore(d)}%`);
      addRow("core", "VIN Validation", sanityCheck(d));
      addRow("core", "Order Readiness", orderReadiness(d));
      addRow("core", "Platform", platformGroup(d));

      // ENGINE
      addRow("engine", "Engine Code", d.EngineModel);
      addRow("engine", "Displacement", d.DisplacementL ? `${d.DisplacementL} L` : "");
      addRow("engine", "Cylinders", d.EngineCylinders);
      addRow("engine", "Fuel Type", d.FuelTypePrimary);
      addRow("engine", "Electrification", d.ElectrificationLevel);
      addRow("engine", "Valve Train", d.ValveTrainDesign);
      addRow("engine", "Turbo", d.Turbo);
      addRow("engine", "Engine Config", d.EngineConfiguration);

      // DRIVE
      addRow("drive", "Transmission", d.TransmissionStyle);
      addRow("drive", "Transmission Speeds", d.TransmissionSpeeds);
      addRow("drive", "Drive Type", d.DriveType);
      addRow("drive", "Brake System", d.BrakeSystemType);

      // BODY
      addRow("body", "Doors", d.Doors);
      addRow("body", "Body Class", d.BodyClass);
      addRow("body", "GVWR", d.GVWR);
      addRow("body", "Wheelbase", d.WheelBaseShort);
      addRow("body", "Track Width", d.TrackWidth);

      // SAFETY
      addRow("safety", "ABS", d.ABS);
      addRow("safety", "ESC", d.ESC);
      addRow("safety", "Traction Control", d.TractionControl);
      addRow("safety", "Air Bags (Front)", d.AirBagLocFront);
      addRow("safety", "Air Bags (Side)", d.AirBagLocSide);

      // ADVANCED (optional)
      if(advancedOn){
        const adv = getPanel("advanced");
        adv.innerHTML = "";
        // dump useful high-signal fields without spamming "Not Applicable"
        const keys = Object.keys(d || {}).sort((a,b)=>a.localeCompare(b));
        keys.forEach(k=>{
          const val = d[k];
          if(!has(val)) return;
          // avoid duplicating core basics
          if(["Make","Model","ModelYear","Trim","Series","VehicleType","BodyClass","EngineModel","DisplacementL","EngineCylinders","FuelTypePrimary","TransmissionStyle","DriveType"].includes(k)) return;
          addRow("advanced", k, val);
        });
      }

      // OEM suggestions
      const drivetrain = [];
      if(isCVT(d)) drivetrain.push("CVT transmission", "Valve body", "TCM");
      else if(isAutomatic(d)) drivetrain.push("Automatic transmission", "Torque converter");
      else if(isManual(d)) drivetrain.push("Manual transmission", "Clutch kit");
      if(isAWD(d)) drivetrain.push("Transfer case", "Rear differential service parts");
      if(isDiesel(d)) drivetrain.push("Fuel filter (diesel)", "Glow plugs (if equipped)");
      if(isElectric(d)) drivetrain.push("Cabin filter", "12V system check");

      const oem = document.getElementById("oem");
      oem.innerHTML = oemSection("Drivetrain (VIN-Aware)", drivetrain);
      oem.style.display = drivetrain.length ? "block" : "none";

      showWorkflow(d);
      showTab("core");
    }

    /* =======================
       COPY-ON-TAP
    ======================= */
    document.addEventListener("click", async (e)=>{
      const row = e.target.closest(".copyable");
      if(!row) return;
      const text = row.getAttribute("data-copy");
      if(!text) return;

      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        showToast("Copied");
      }
    });

    /* =======================
       INPUT UX (clean + optional auto decode)
    ======================= */
    let autoTimer = null;

    vinEl.addEventListener("input", ()=>{
      const cleaned = clean(vinEl.value);
      if(vinEl.value !== cleaned) vinEl.value = cleaned;

      if(cleaned.length && !valid(cleaned)) setStatus("Enter a valid 17-char VIN (no I/O/Q).", "warn");
      if(cleaned.length === 17 && valid(cleaned)) setStatus("Ready to decode.", "");

      if(document.getElementById("autoDecode").checked && cleaned.length === 17 && valid(cleaned)){
        clearTimeout(autoTimer);
        autoTimer = setTimeout(()=> decode(), 250);
      }
    });

    vinEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        decode();
      }
    });

    /* =======================
       BUTTONS
    ======================= */
    function resetAll(){
      vinEl.value = "";
      vehicleEl.style.display = "none";
      clearPanels();
      document.getElementById("oem").innerHTML = "";
      document.getElementById("oem").style.display = "none";
      document.getElementById("workflow").style.display = "none";
      setStatus("", "");
      showTab("core");
      busy = false;
      decodeBtn.disabled = false;
      last = { vin:"", d:null, ts:0, source:"" };
    }

    function printReport(){
      if(!last.d){
        setStatus("Decode a VIN first, then print.", "warn");
        return;
      }
      window.print();
    }

    /* =======================
       SAMPLE VINs (for testing UI)
    ======================= */
    const samples = [
      "1HGCM82633A004352", // Honda (sample)
      "1FTFW1ET1EFA00001", // Ford (sample)
      "2T1BURHE5JC000001", // Toyota (sample)
      "1N4AL3AP9JC000001"  // Nissan (sample)
    ];
    let sampleIdx = 0;
    function fillSample(){
      vinEl.value = samples[sampleIdx % samples.length];
      sampleIdx++;
      vinEl.dispatchEvent(new Event("input"));
      setStatus("Sample VIN loaded. Tap Decode.", "");
    }

    /* =======================
       ADVANCED toggle
    ======================= */
    function toggleAdvanced(){
      advancedOn = !advancedOn;
      const btn = document.getElementById("advTabBtn");
      btn.style.display = advancedOn ? "inline-flex" : "none";
      showToast(advancedOn ? "Advanced ON" : "Advanced OFF");
      // re-render if we have data
      if(last.d) renderAll(last.d, last.vin);
      if(!advancedOn && activePanel === "advanced") showTab("core");
    }

    /* =======================
       HISTORY
    ======================= */
    function loadHistory(){
      try{
        const raw = localStorage.getItem(HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveHistory(){
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }
    function pushHistory(vin, d){
      const title = `${d.ModelYear||""} ${d.Make||""} ${d.Model||""}`.trim();
      history = history.filter(x => x.vin !== vin);
      history.unshift({ vin, title: title || "Vehicle", t: Date.now() });
      history = history.slice(0, 8);
      saveHistory();
    }
    function renderHistory(){
      const wrap = document.getElementById("history");
      const chips = document.getElementById("chips");
      chips.innerHTML = "";

      if(!history.length){
        wrap.style.display = "none";
        return;
      }

      wrap.style.display = "block";
      history.forEach(h=>{
        chips.insertAdjacentHTML("beforeend", `
          <div class="chip" data-v="${escapeHtml(h.vin)}">
            ${escapeHtml(h.vin)}
            <span>${escapeHtml(h.title)}</span>
          </div>
        `);
      });

      chips.querySelectorAll(".chip").forEach(c=>{
        c.addEventListener("click", ()=>{
          const v = c.getAttribute("data-v") || "";
          vinEl.value = v;
          vinEl.dispatchEvent(new Event("input"));
          decode();
        });
      });
    }
    function clearHistory(){
      history = [];
      saveHistory();
      renderHistory();
      showToast("History cleared");
    }

    // initial render
    renderHistory();
    setStatus("", "");
  </script>
</body>
</html>
