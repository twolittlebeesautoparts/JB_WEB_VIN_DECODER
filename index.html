<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>JB VIN Decoder</title>

    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#0b1210">

    <style>
        :root{
          --bg:#0b1210;
          --card:#121c18;
          --row:#0f1714;
          --text:#e9fff4;
          --muted:#9bb0a6;
          --accent:#ff3d00;
          --accent2:#ff6a00;
          --ok:#2fd37b;
          --bad:#ff5d5d;
          --warn:#ffcc66;
        }
        .tab{
  margin-top:8px;
  padding:8px;
  border-radius:10px;
  background:#1a1a1a;
  color:var(--muted);
  border:1px solid rgba(255,255,255,.1);
  font-size:12px;
}
        .tab.active{
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#000;
}


        *{box-sizing:border-box}

        body{
          margin:0;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          background:var(--bg);
          color:var(--text);
        }

        .app{
          max-width:520px;
          margin:0 auto;
          padding:14px;
        }

        .header{text-align:center;padding:12px 0 6px}

        .logo{
          width:56px;height:56px;margin:0 auto 8px;
          border-radius:14px;background:#1a1a1a;
          display:flex;align-items:center;justify-content:center;
          font-weight:900;color:var(--accent)
        }

        .logo img{width:100%;height:100%;object-fit:cover;border-radius:14px}

        h1{margin:4px 0 2px;font-size:18px;font-weight:900}
        .sub{font-size:11px;color:var(--muted)}

        .card{
          background:var(--card);
          border-radius:18px;
          padding:14px;
          margin-top:14px;
        }

        input{
          width:100%;padding:12px;border-radius:14px;
          border:1px solid rgba(255,255,255,.15);
          background:#0c1612;color:var(--text);
          text-transform:uppercase;font-size:14px;
        }

        button{
          width:100%;margin-top:10px;padding:12px;
          border-radius:14px;border:0;font-size:14px;
          font-weight:900;cursor:pointer;
        }

        .primary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#000}
        .secondary{background:#1a1a1a;color:var(--text);border:1px solid rgba(255,255,255,.15)}

        .status{margin-top:10px;font-size:12px;min-height:18px}
        .status.ok{color:var(--ok)}
        .status.bad{color:var(--bad)}
        .status.warn{color:var(--warn)}

        .vehicle{
          margin-top:14px;padding:12px;border-radius:16px;
          background:linear-gradient(135deg,#141414,#1b1b1b);
          text-align:center;font-weight:900;font-size:17px;display:none;
        }

        .results,.oem{margin-top:12px;display:grid;gap:8px}

        .row{
          display:flex;justify-content:space-between;
          background:var(--row);padding:10px 12px;
          border-radius:12px;border:1px solid rgba(255,255,255,.06);
        }

        .k{font-size:11px;color:var(--muted)}
        .v{font-size:13px;font-weight:800;text-align:right}

        .oem h3{
          font-size:13px;
          margin:6px 0;
          color:var(--accent2);
        }

        .disclaimer{
          margin-top:12px;font-size:10px;color:#888;line-height:1.4;
        }

        .footer{text-align:center;margin-top:16px;font-size:10px;color:#777}
    </style>
</head>

<body>
<div class="app">

    <div class="header">
        <div class="logo">
            <img src="logo.png" onerror="this.remove();this.parentNode.textContent='JB';">
        </div>
        <h1>JB VIN Decoder</h1>
        <div class="sub">Powered by NHTSA vPIC</div>
    </div>

    <div class="card">
    <input id="vin" maxlength="17" placeholder="ENTER 17-CHARACTER VIN">
    <button class="primary" onclick="decode()">Decode VIN</button>
    <button class="secondary" onclick="reset()">Reset</button>
    <button class="secondary" onclick="printPage()">Print</button>

    <div id="status" class="status"></div>
    <div id="vehicle" class="vehicle"></div>
        <button onclick="showTab('core')" class="tab active">Core</button>
  <button onclick="showTab('engine')" class="tab">Engine</button>
  <button onclick="showTab('drive')" class="tab">Drive</button>
  <button onclick="showTab('body')" class="tab">Body</button>
  <button onclick="showTab('safety')" class="tab">Safety</button>
    <div id="core" class="results tab-panel"></div>
<div id="engine" class="results tab-panel" style="display:none"></div>
<div id="drive" class="results tab-panel" style="display:none"></div>
<div id="body" class="results tab-panel" style="display:none"></div>
<div id="safety" class="results tab-panel" style="display:none"></div>

    <div id="oem" class="oem" style="display:none"></div>

    <!-- ✅ ADD WORKFLOW UI RIGHT HERE -->
    <div id="workflow" style="display:none">
        <h3 style="margin-top:0;color:var(--accent2)">
            Parts Counter Guide
        </h3>

        <div id="safe"></div>
        <div id="verify"></div>
        <div id="unsafe"></div>
    </div>
    <!-- ✅ END -->

    <div class="disclaimer">
        OEM compatibility is VIN-matched by configuration.
        Exact part numbers require manufacturer or licensed catalogs.
    </div>
</div>

<script>
/* =======================
   STATE
======================= */
let activePanel = "core";
let busy = false;

/* =======================
   BASIC HELPERS
======================= */
function clean(v){
  return v.toUpperCase().replace(/[^A-Z0-9]/g,"");
}

function valid(v){
  return v.length === 17 && !/[IOQ]/.test(v);
}

/* =======================
   CONFIG DETECTORS
======================= */
function isCVT(d){ return d.TransmissionStyle?.toLowerCase().includes("cvt"); }
function isAutomatic(d){ return d.TransmissionStyle?.toLowerCase().includes("auto"); }
function isManual(d){ return d.TransmissionStyle?.toLowerCase().includes("manual"); }
function isDiesel(d){ return d.FuelTypePrimary?.toLowerCase().includes("diesel"); }
function isElectric(d){ return d.ElectrificationLevel?.toLowerCase().includes("electric"); }
function isAWD(d){ return d.DriveType?.toLowerCase().includes("awd"); }

/* =======================
   SCORING / LOGIC
======================= */
function confidenceScore(d){
  let s = 0;
  if(d.EngineModel) s+=20;
  if(d.TransmissionStyle) s+=20;
  if(d.DriveType) s+=20;
  if(d.BodyClass) s+=20;
  if(d.PlantCountry) s+=20;
  return s;
}

function orderReadiness(d){
  if(d.EngineModel && d.TransmissionStyle)
    return "✓ Ready for most mechanical parts";
  return "⚠ Verify configuration before ordering";
}

function platformGroup(d){
  if(d.Make==="TOYOTA" && d.Model==="Corolla")
    return "Toyota E170 / E180 platform";
  if(d.Make==="HONDA" && d.Model==="Civic")
    return "Honda Global Small platform";
  return "Platform data unavailable";
}

function sanityCheck(d){
  if(d.Make==="TOYOTA" && d.Model==="Corolla"){
    if(d.EngineModel && !["2ZR-FE","1ZZ-FE"].includes(d.EngineModel)){
      return "⚠ Uncommon engine for Corolla";
    }
  }
  return "✓ VIN configuration consistent";
}

/* =======================
   UI HELPERS (TAB-AWARE)
======================= */
function row(k, v){
  if(!v || v === "Not Applicable") return;

  const panel = document.getElementById(activePanel);
  if(!panel) return;

  panel.innerHTML += `
    <div class="row">
      <div class="k">${k}</div>
      <div class="v">${v}</div>
    </div>
  `;
}

function oemSection(title, list){
  if(!list.length) return "";
  return `<h3>${title}</h3>` +
    list.map(i => `
      <div class="row">
        <div class="k">•</div>
        <div class="v">${i}</div>
      </div>
    `).join("");
}

/* =======================
   TAB SWITCHING
======================= */
function showTab(id){
  activePanel = id;

  document.querySelectorAll(".tab-panel").forEach(p => {
    p.style.display = "none";
  });

  const panel = document.getElementById(id);
  if(panel) panel.style.display = "grid";

  document.querySelectorAll(".tab").forEach(b => {
    b.classList.remove("active");
  });

  const btn = document.querySelector(
    `.tab[onclick="showTab('${id}')"]`
  );
  if(btn) btn.classList.add("active");
}

/* =======================
   MAIN DECODE
======================= */
async function decode(){
  let v = clean(vin.value);
  vin.value = v;

  if(!valid(v)){
    status.textContent = "Invalid VIN";
    status.className = "status bad";
    return;
  }
  if(busy) return;
  busy = true;

  status.textContent = "Decoding VIN…";
  status.className = "status warn";

  document.querySelectorAll(".tab-panel").forEach(p => p.innerHTML = "");
  oem.innerHTML = "";
  oem.style.display = "none";
  vehicle.style.display = "none";

  try{
    const api =
      "https://api.allorigins.win/raw?url=" +
      encodeURIComponent(
        `https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${v}?format=json`
      );

    const r = await fetch(api);
    const json = await r.json();
    const d = json.Results[0];

    vehicle.innerHTML = `
      ${d.ModelYear} ${d.Make} ${d.Model}<br>
      <span style="font-size:12px;color:#aaa">
        ${d.EngineModel || "Unknown"} •
        ${d.TransmissionStyle || "Unknown"} •
        ${d.DriveType || "Unknown"}
      </span>`;
    vehicle.style.display = "block";

    /* CORE */
    activePanel = "core";
    row("VIN", v);
    row("Model Year", d.ModelYear);
    row("Make", d.Make);
    row("Model", d.Model);
    row("Trim", d.Trim);
    row("Decode Confidence", `${confidenceScore(d)}%`);
    row("VIN Validation", sanityCheck(d));
    row("Order Readiness", orderReadiness(d));
    row("Platform", platformGroup(d));

    /* ENGINE */
    activePanel = "engine";
    row("Engine Code", d.EngineModel);
    row("Displacement", d.DisplacementL && `${d.DisplacementL} L`);
    row("Cylinders", d.EngineCylinders);
    row("Fuel Type", d.FuelTypePrimary);

    /* DRIVE */
    activePanel = "drive";
    row("Transmission", d.TransmissionStyle);
    row("Drive Type", d.DriveType);

    /* BODY */
    activePanel = "body";
    row("Body Class", d.BodyClass);
    row("Doors", d.Doors);

    /* SAFETY */
    activePanel = "safety";
    row("ABS", d.ABS);
    row("ESC", d.ESC);

    /* OEM */
    const drivetrain = [];
    if(isCVT(d)) drivetrain.push("CVT transmission","Valve body","TCM");
    else if(isAutomatic(d)) drivetrain.push("Automatic transmission","Torque converter");
    else if(isManual(d)) drivetrain.push("Manual transmission","Clutch");
    if(isAWD(d)) drivetrain.push("Transfer case");

    oem.innerHTML = oemSection("Drivetrain (VIN-Aware)", drivetrain);
    oem.style.display = "block";

    showTab("core");
    status.textContent = "VIN decoded successfully";
    status.className = "status ok";

  }catch{
    status.textContent = "Decode failed";
    status.className = "status bad";
  }

  busy = false;
}

/* =======================
   BUTTONS
======================= */
function reset(){
  vin.value = "";
  status.textContent = "";
  status.className = "status";
  document.querySelectorAll(".tab-panel").forEach(p => p.innerHTML = "");
  oem.innerHTML = "";
  oem.style.display = "none";
  vehicle.style.display = "none";
  showTab("core");
  busy = false;
}

function printPage(){
  window.print();
}
</script>

</body>
</html>
